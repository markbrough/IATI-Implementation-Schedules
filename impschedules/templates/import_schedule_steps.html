{% extends "base.html" %}
{% block content %}
    
    <ul class="nav nav-tabs hidden" id="pageTab">
        <li><a href="#first" data-toggle="tab" class="first">New/existing</a></li>
        <li><a href="#second" data-toggle="tab" class="second">Basic information</a></li>
        <li><a href="#third" data-toggle="tab" class="third">Detailed information</a></li>
    </ul>

    <h1>Edit and import schedule</h1>
    <p class="lead">{{doc.find("metadata").find("publisher").text}}: {{doc.find("metadata").find("schedule_type").text}} <code>{{doc.find("metadata").find("schedule_type").get("code")}}</code></p>
    <div class="alert alert-info">Some schedules are messy and the importing tool can only handle so much. Where there are mistakes, please correct them. Some assumptions have been made to help, but check that you're happy with them.</div>
    <form action="" method="post">

    <div class="tab-content">
        <div class="tab-pane" id="first">
            <fieldset>
                <legend>Create new or update existing schedule</legend>
                <p>
                <span><label for="import-new"><input type="radio" name="createupdate" id="import-new" checked> New</input></label></span>
                <span><label for="import-existing"><input type="radio" name="createupdate" id="import-existing" disabled> Existing</input></label>
                <select name="existing-publisher" disabled>
                <option value="id">Name</option>
                </select>
                </span>
                </p>
            </fieldset>
            <p><a href="#second" data-toggle="tab" class="btn btn-success second">Next &raquo;</a></p>
        </div>
        <div class="tab-pane" id="second">
            <fieldset>
                <legend>Basic information</legend>
                  <p><a href="#first" data-toggle="tab" class="btn first">&laquo; Back</a> <a href="#third" data-toggle="tab" class="btn btn-success third">Next &raquo;</a></p>
                <table class="table">
                    <thead>
                        <th>Field</th>
                        <th>Original</th>
                        <th>Actual</th>
                        <th>Reason for change</th>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Publisher name</td>
                            <td><input type="text" class="publisher_name original" value="{{doc.find("metadata").find("publisher").text}}" readonly/></td>
                            <td><input type="text" class="publisher_name actual" value="{{doc.find("metadata").find("publisher").text}}"/></td>
                            <td><div class="control-group"><select class="publisher_name change" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        <tr>
                            <td>Publisher code</td>
                            <td><input type="text" class="publisher_code original" value="{{doc.find("metadata").find("publisher").get("code")}}" readonly/></td>
                            <td><input type="text" class="publisher_code actual" value="{{doc.find("metadata").find("publisher").get("code")}}"/></td>
                            <td><div class="control-group"><select class="publisher_code change" name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        <tr>
                            <td>Schedule date</td>
                            <td><input type="text" class="schedule_date original" value="{{doc.find("metadata").find("date").text}}" readonly/></td>
                            <td><input type="text" class="schedule_date actual" value="{{doc.find("metadata").find("date").text}}"/></td>
                            <td><div class="control-group"><select class="schedule_date change" name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        <tr>
                            <td>Schedule version</td>
                            <td><input type="text" class="schedule_version original" value="{{doc.find("metadata").find("version").text}}" readonly/></td>
                            <td><input type="text" class="schedule_version actual" value="{{doc.find("metadata").find("version").text}}"/></td>
                            <td><div class="control-group"><select class="schedule_version change" name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        <tr>
                            <td>Initial implementation date</td>
                            <td><input type="text" class="publishing_timetable_date_initial original" value="{{doc.find("publishing").find("publication-timetable").get("date-initial")}}" readonly/></td>
                            <td><input type="text" class="publishing_timetable_date_initial actual" value="{{doc.find("publishing").find("publication-timetable").get("date-initial")}}" name="publishing_timetable_date_initial" id="publishing_timetable_date_initial" /></td>
                            <td><div class="control-group"><select class="publishing_timetable_date_initial change" name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        <tr>
                            <td>Frequency</td>
                            <td><input class="publishing_timetable_frequency original" type="text" value="{{doc.find("publishing").find("publication-frequency").get("frequency")}}" readonly/></td>
                            <td>
                            <select class="publishing_timetable_frequency actual">
                                {% for key, value in properties.codes[properties.properties['publishing_frequency_frequency']["code"]].items() %}
                                <option value="{{key}}" {% if key == (doc.find("publishing").find("publication-frequency").get("frequency")) %}selected {%endif%}>{{value}}</option>
                                {%endfor%}
                            </select>
                            </td>
                            <td><div class="control-group"><select class="publishing_timetable_frequency change" name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        <tr>
                            <td>Timeliness</td>
                            <td><input type="text" class="publishing_timetable_timeliness original" value="{{doc.find("publishing").find("publication-frequency").get("timeliness")}}" readonly/></td>
                            <td>
                            <select class="publishing_timetable_timeliness actual">
                                {% for key, value in properties.codes[properties.properties['publishing_frequency_timeliness']["code"]].items() %}
                                <option value="{{key}}" {% if key == (doc.find("publishing").find("publication-frequency").get("timeliness")) %}selected {%endif%}>{{value}}</option>
                                {%endfor%}
                            </select></td>
                            <td><div class="control-group"><select class="publishing_timetable_timeliness change" name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        <tr>
                            <td>Timeline narrative</td>
                            <td><textarea readonly class="publishing_timetable_narrative original" rows="4">{{doc.find("publishing").find("publication-frequency").find("narrative").text}}</textarea></td>
                            <td><textarea class="publishing_timetable_narrative actual" rows="4">{{doc.find("publishing").find("publication-frequency").find("narrative").text}}</textarea></td>
                            <td><div class="control-group"><select class="publishing_timetable_narrative change" name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        <tr>
                            <td>Thresholds</td>
                            <td><textarea class="publishing_thresholds original" readonly rows="4">{{doc.find("publishing").find("thresholds").find("narrative").text}}</textarea></td>
                            <td><textarea class="publishing_thresholds actual" rows="4">{{doc.find("publishing").find("thresholds").find("narrative").text}}</textarea></td>
                            <td><div class="control-group"><select class="publishing_thresholds change" name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        <tr>
                            <td>Exclusions</td>
                            <td><textarea class="publishing_exclusions original" readonly rows="4">{{doc.find("publishing").find("exclusions").find("narrative").text}}</textarea></td>
                            <td><textarea class="publishing_exclusions actual" rows="4">{{doc.find("publishing").find("exclusions").find("narrative").text}}</textarea></td>
                            <td><div class="control-group"><select class="publishing_exclusions change" name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        <tr>
                            <td>License</td>
                            <td><input class="publishing_license original" type="text" value="{{doc.find("publishing").find("license").get("license")}}" readonly/></td>
                            <td><select class="publishing_license actual">
                                {% for key, value in properties.codes[properties.properties['publishing_license']["code"]].items() %}
                                <option value="{{key}}" {% if key == (doc.find("publishing").find("license").get("license")) %}selected {%endif%}>{{value}}</option>
                                {%endfor%}
                            </select></td>
                            <td><div class="control-group"><select class="publishing_license change" name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        <tr>
                            <td>Scope</td>
                            <td><input class="publishing_scope original" type="text" value="{{doc.find("publishing").find("scope").get("value")}}" readonly/></td>
                            <td><input class="publishing_scope actual" type="text" value="{{doc.find("publishing").find("scope").get("value")}}"/></td>
                            <td><div class="control-group"><select class="publishing_scope change" name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        <tr>
                            <td>Scope narrative</td>
                            <td><textarea class="publishing_scope_narrative original" readonly rows="4">{{doc.find("publishing").find("scope").find("narrative").text}}</textarea></td>
                            <td><textarea class="publishing_scope_narrative actual" rows="4">{{doc.find("publishing").find("scope").find("narrative").text}}</textarea></td>
                            <td><div class="control-group"><select class="publishing_scope_narrative change" name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                    </tbody>
                </table>
            </fieldset>
            <p><a href="#first" data-toggle="tab" class="btn first">&laquo; Back</a> <a href="#third" data-toggle="tab" class="btn btn-success third">Next &raquo;</a></p>
        </div>
        <div class="tab-pane" id="third">
            <fieldset>
                <legend>Detailed information</legend>
            <p><a href="#second" data-toggle="tab" class="btn second">&laquo; Back</a> <input type="submit" value="Import schedule" class="btn btn-success" name="do_import" /></p>
                <table class="table">
                    <thead>
                        <th>Field</th>
                        <th>Property</th>
                        <th>Original</th>
                        <th>Actual</th>
                        <th>Reason for change</th>
                    </thead>
                    <tbody>
                        {% for level in ('organisation', 'activity') %}
                        <tr class="info">
                        <td colspan="5"><b>{{level|capitalize}} level</b></td>
                        </tr>
                        {% for element in doc.find(level) %}
                        <tr>
                            <td rowspan="3">{{element.tag}}{% if element.get("type") %} ({{element.get("type")}}){%endif%}</td>
                            <td>Status</td>
                            <td><input type="text" value="{{element.find("status").get("category")}}" class="{{element.tag}}{% if element.get("type") %}-{{element.get("type")}}{%endif%} status_original" readonly/></td>
                            <td><select class="{{element.tag}}{% if element.get("type") %}-{{element.get("type")}}{%endif%} status_actual" >
                                <option value="" {%if (element.find("status").get("category")) is none %}selected{%endif%} ></option>
                                {% for key, value in properties.status.items() %}
                                <option value="{{key}}" {% if key == (element.find("status").get("category")) %}selected {%endif%}>{{value}}</option>
                                {%endfor%}
                            </select></td>
                            <td><div class="control-group"><select name="change_reason" class="{{element.tag}}{% if element.get("type") %}-{{element.get("type")}}{%endif%} status_change" disabled><option value=""></option><option value="initial_date">Initial date later</option>
<option value="no_date">No date provided</option></select></div></td>
                        <tr>
                            <td>Date</td>
                            <td><input type="text" value="{{element.find("publication-date").text}}" class="{{element.tag}}{% if element.get("type") %}-{{element.get("type")}}{%endif%} date_original" readonly/></td>
                            <td><input type="text" value="{{element.find("publication-date").text}}" class="{{element.tag}}{% if element.get("type") %}-{{element.get("type")}}{%endif%} date_actual"  /></td>
                            <td>
                                <div class="control-group">
                                <select name="change_reason" class="{{element.tag}}{% if element.get("type") %}-{{element.get("type")}}{%endif%} date_change" disabled>
<option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}
                                </select>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Notes</td>
                            <td><textarea readonly>{{element.find("notes").text}}</textarea></td>
                            <td><textarea>{{element.find("notes").text}}</textarea></td>
                            <td><div class="control-group"><select name="change_reason" disabled><option></option>                                {% for key, value in properties.change_reasons.items() %}
                                <option value="{{key}}">{{value}}</option>
                                {%endfor%}</select></div></td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </fieldset>
            <p><a href="#second" data-toggle="tab" class="btn second">&laquo; Back</a> <input type="submit" value="Import schedule" class="btn btn-success" name="do_import" /></p>
        </div>
    </div>
    </form>
    
    <script>
     var initial_date;
     $(".third").click(function(){ 
        doSetupForm();
     });
     function doSetupForm() {
        initial_date = $("#publishing_timetable_date_initial").val();
        if (initial_date == '') {
            $("#third .status_actual").each(function() {
                element = $(this).attr('class');
                element = element.replace(" status_actual", "");
                
                $("." + element + ".status_actual").attr('value', "");
                $("." + element + ".date_actual").attr('value', "");
                $("." + element + ".date_change").removeAttr('disabled').val('no_date');
                $("." + element + ".status_change").removeAttr('disabled').val('no_date');
            });
        } else {
            ensureInitial();
        }
     }
     $(function () {
        $('#pageTab .first').tab('show');
     });
     $("#third select, #third input").change(function(){
        if ($(this).is("select")) {
            element = $(this).attr('class');
            original = element.replace(" status_actual", ".status_original");
            changereason = element.replace(" status_actual", ".status_change");
        } else {
            element = $(this).attr('class');
            original = element.replace(" date_actual", ".date_original");
            changereason = element.replace(" date_actual", ".date_change");
        }
        if ($(this).val() != $('.'+original).val()) {
            changer = $("."+changereason);
            changer.removeAttr('disabled');
            ensureSelectNotEmpty(changer);
        } else {
            changer = $("."+changereason);
            changer.closest(".control-group").removeClass("error");
            changer.attr('disabled', 'disabled');
        }
     });

     $("#second select, #second input, #second textarea").change(function(){
        element = $(this).attr('class');
        original = element.replace(" actual", ".original");
        changereason = element.replace(" actual", ".change");
        if ($(this).val() != $('.'+original).val()) {
            changer = $("."+changereason);
            changer.removeAttr('disabled');
            ensureSelectNotEmpty(changer);
        } else {
            changer = $("."+changereason);
            changer.closest(".control-group").removeClass("error");
            changer.attr('disabled', 'disabled');
        }
     });
     $("select").change(function(){
        ensureSelectNotEmpty(this);
     });

     function ensureSelectNotEmpty(element) {
        if ($(element).val() == "") {
            $(element).closest(".control-group").addClass("error");
        } else {
            $(element).closest(".control-group").removeClass("error");
        }
     }
     function ensureInitial() {
        // date must not be earlier than the initial publication date for any element, if publication status is fc
        // if initial publication date is empty, then no elements are published.
        var element
        $("#third .status_original").each(function() {
            element = $(this).attr('class');
            element = element.replace(" status_original", "");
            status = $(this).attr('value');
            if ((status == 'fc') && ($("." + element + ".date_actual").val() == "")) {
                $("." + element + ".date_actual").attr('value', initial_date);
                $("." + element + ".date_change").removeAttr('disabled').val('no_date');
            } else if ((status == 'fc') && ($("." + element + ".date_actual").val() < initial_date)) {
                $("." + element + ".date_actual").attr('value', initial_date);
                $("." + element + ".date_change").removeAttr('disabled').val('initial_date');
            }
            if (((status == 'fp') || (status == 'pc')) && ($("." + element + ".date_actual").val() != '') && ($("." + element + ".date_actual").val() < initial_date)) {
                $("." + element + ".date_actual").attr('value', initial_date);
                $("." + element + ".date_change").removeAttr('disabled').val('initial_date');
            }
        });
    }
    </script>
{% endblock %}
